# Contributing

Contributions are welcome, and they are greatly appreciated!

## Local Development Setup

1. Fork the `whisk` repo [on GitHub](https://github.com/whisk-ml/whisk).
2. Clone your fork locally:
    ```
    $ git clone git@github.com:your_name_here/whisk.git
    ```
3. Install your local copy into a venv:
    ```
    $ cd whisk/
    $ python3 -m venv venv
    $ source venv/bin/activate
    $ python setup.py develop
    $ pip install -r requirements_dev.txt
    ```
4. Create a branch for local development::
    ```
    $ git checkout -b name-of-your-bugfix-or-feature
    ```
   Now you can make your changes locally.

5. When you're done making changes, check that your changes pass flake8 and the
   tests, including testing other Python versions with tox::
   ```
    $ flake8 whisk tests
    $ pytest -s --ignore=whisk/template
    $ tox
    ```
6. Commit your changes and push your branch to GitHub::
    ```
    $ git add .
    $ git commit -m "Your detailed description of your changes."
    $ git push origin name-of-your-bugfix-or-feature
    ```
7. Submit a pull request through the GitHub website.

## Pull Request Guidelines

Before you submit a pull request, check that it meets these guidelines:

1. The pull request should include tests.
2. If the pull request adds functionality, the docs should be updated. Put
   your new functionality into a function with a docstring.
3. The pull request should work for Python 3.6, 3.7 and 3.8, and for PyPy. Check
   [CircleCI](https://app.circleci.com/pipelines/github/whisk-ml/whisk)
   and make sure that the tests pass for all Python versions.

## Releasing

_Only whisk project [collaborators](https://pypi.org/manage/project/whisk/collaboration/) can release a new version._

Make sure all your changes are pushed (including an entry in `CHANGELOG.md`) and pass [CI tests](https://app.circleci.com/pipelines/github/whisk-ml/whisk).

Then run:

    $ bump2version patch # possible: major / minor / patch
    $ git push
    $ git push --tags
    $ make release

We intended to have CircleCI perform the release, but it's [having issues with git tags](https://discuss.circleci.com/t/jobs-triggered-by-annotated-tags-fail-when-using-built-in-git-client/34486).

If doing a patch, you can just run:

    $ make bump-push release

## Creating a demo project

To create a demo project from your local fork of whisk:

1. Set the following environment variables:
    ```
    PROJECT_DEMO_DIR=/path/to/dir # The directory where the demo project will be created
    PROJECT_DEMO_NAME=demo # The name of the project
    ```
2. Then run the make task:
    ```
    $ make create-demo
    ```
`make create-demo` deletes the existing demo project (if it exists) and creates a new project.

## Tips

### Running a subset of tests

To run a subset of tests::

    $ pytest tests/test_whisk.py

### Testing the source code vs. the package

When running `pytest`, you are testing the source code in the current `venv`. When running `tox`, you are testing the package generated by `python setup.py sdist`. It's important to run `tox` as it runs test against the package other users will install. `tox` can fail even if `pytest` succeeds because of an incorrect `MANIFEST.in` file or missing dependencies within the `setup.py` `install_requires` argument.

### Checking MANIFEST.in

It's easy to add files to version control but forget to include in the MANIFEST.in file. After committing changes, run the following to see if any files are missing:

    $ check-manifest


### Updating the getting started notebook


The project contains a notebook to help orientate new users. You can modify this notebook in the demo project and update the template with:

    $ make update-notebook

## CircleCI Setup

The following is required to run the included CircleCI workflows:

1. An org context named `whisk`.
2. The following environment variables added to the context:
      * GIT_AUTHOR_EMAIL
      * GIT_AUTHOR_NAME
      * GIT_COMMITTER_EMAIL
      * GIT_COMMITTER_NAME
      * PYPI_PASSWORD
      * PYPI_USERNAME
